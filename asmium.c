#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdint.h>

#define BUF_SIZE  4096

#define BIN_BUF_SIZE  4096

typedef enum {
  kNotInToken,
  kInToken,
} TokenizerState;

typedef enum {
  kUnknown,
  kValue,
  kMnemonic,
  kOp,
  kLabel,
  kRegister,
} TokenType;

const char *mnemonic_name[] = {
  "push",
  "pop",
  "xor",
  "mov",
  "nop",
  "retq",
  NULL
};

const char *op_name[] = {
  "=",
  NULL
};

const char *register_name[] = {
  "eax",
  "rbp",
  "rsp",
  NULL
};

char buf[BUF_SIZE + 16];
char *token_buf[1024];
TokenType token_buf_type[1024];
int token_buf_count;

uint8_t bin_buf[BIN_BUF_SIZE];
size_t bin_buf_size;

int find(const char **list, const char *token)
{
  for(int i = 0; list[i]; i++){
    if(strcmp(token, list[i]) == 0) return i;
  }
  return -1;
}

int getTypeOfToken(const char *token){
  int idx;
  if(~(idx = find(mnemonic_name, token))) return kMnemonic;
  if(~(idx = find(op_name, token))) return kOp;
  if(~(idx = find(register_name, token))) return kRegister;
  return kUnknown;
}

uint8_t mach_o_header[0x130] = {
0xcf, 0xfa, 0xed, 0xfe, 0x07, 0x00, 0x00, 0x01, 0x03, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
0x04, 0x00, 0x00, 0x00, 0x10, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x19, 0x00, 0x00, 0x00, 0x98, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00,
0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x5f, 0x5f, 0x74, 0x65, 0x78, 0x74, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x5f, 0x5f, 0x54, 0x45, 0x58, 0x54, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00,
0x00, 0x0c, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x18, 0x00, 0x00, 0x00,
0x38, 0x01, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x48, 0x01, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00,
0x0b, 0x00, 0x00, 0x00, 0x50, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

void PrintHeader(uint32_t binsize){
  *((uint32_t *)&mach_o_header[0x40]) = binsize;
  *((uint32_t *)&mach_o_header[0x50]) = binsize;
  *((uint32_t *)&mach_o_header[0x90]) = binsize;

  uint32_t binsize_4b_aligned = (binsize + 0x03) & ~0x03;
  *((uint32_t *)&mach_o_header[0xd0]) = binsize_4b_aligned + 0x130;
  *((uint32_t *)&mach_o_header[0xd8]) = binsize_4b_aligned + 0x140;
  for(int i = 0; i < 0x130; i++){
    printf("%02X ", mach_o_header[i]);
  }
}

void PrintBody(){
  int i;
  for(i = 0; i < bin_buf_size; i++){
    printf("%02X ", bin_buf[i]);
  }
  // 4-byte align
  for(; i & 0x3; i++){
    printf("00 ");
  }
}

void PrintFooter(){
  puts("01 00 00 00 0f 01 00 00");
  puts("00 00 00 00 00 00 00 00 00 5f 6d 61 69 6e 00 00");
}

int main(int argc, char *argv[])
{
  if(argc < 2) return 1;
  FILE *fp = fopen(argv[1], "rb");

  if(!fp) return 0;

  int size = fread(buf, 1, BUF_SIZE, fp);
  
  TokenizerState state = kNotInToken;
  char *p;


  int token_buf_count = 0;
  for(int i = 0; i <= size; i++){
    if(i >= size || buf[i] <= ' '){
      buf[i] = 0;
      if(state == kInToken){
        state = kNotInToken;
        token_buf[token_buf_count] = p;
        token_buf_type[token_buf_count] = getTypeOfToken(p);
        token_buf_count++;
      }
      if(i >= size) break;
      continue;
    }
    if(state == kNotInToken){
      state = kInToken;
      p = &buf[i];
    }
    //printf("%02X ", buf[i]);
  }
  for(int i = 0; i < token_buf_count; ){
    //printf("%s %d\n", token_buf[i], token_buf_type[i]);
    if(strcmp(token_buf[i], "push") == 0){
      i++;
      if(strcmp(token_buf[i], "rbp") == 0){
        i++;
        bin_buf[bin_buf_size++] = 0x55;
      } else{
        return 1;
      }
    } else if(strcmp(token_buf[i], "mov") == 0){
      i++;
      i++;
      i++;
      bin_buf[bin_buf_size++] = 0x48;
      bin_buf[bin_buf_size++] = 0x89;
      bin_buf[bin_buf_size++] = 0xe5;
    } else if(strcmp(token_buf[i], "xor") == 0){
      i++;
      i++;
      i++;
      bin_buf[bin_buf_size++] = 0x31;
      bin_buf[bin_buf_size++] = 0xc0;
    } else if(strcmp(token_buf[i], "pop") == 0){
      i++;
      i++;
      bin_buf[bin_buf_size++] = 0x5d;
    } else if(strcmp(token_buf[i], "retq") == 0){
      i++;
      bin_buf[bin_buf_size++] = 0xc3;
    } else if(strcmp(token_buf[i], "nop") == 0){
      i++;
      bin_buf[bin_buf_size++] = 0x90;
    }
  }

  PrintHeader(bin_buf_size);
  PrintBody();
  PrintFooter();

  return 0;
}
