#include <stdint.h>
#include <stdio.h>

#include "asmium.h"

extern uint8_t mach_o_header[0x130];
extern uint8_t mach_o_footer[0x18];

void WriteObjFileForMachO(FILE *fp, uint8_t *bin_buf, uint32_t bin_size) {
  // header
  *((uint32_t *)&mach_o_header[0x40]) = bin_size;
  *((uint32_t *)&mach_o_header[0x50]) = bin_size;
  *((uint32_t *)&mach_o_header[0x90]) = bin_size;

  uint32_t binsize_4b_aligned = (bin_size + 0x03) & ~0x03;
  *((uint32_t *)&mach_o_header[0xd0]) = binsize_4b_aligned + 0x130;
  *((uint32_t *)&mach_o_header[0xd8]) = binsize_4b_aligned + 0x140;
  for (int i = 0; i < 0x130; i++) {
    fputc(mach_o_header[i], fp);
  }
  // body
  int i;
  for (i = 0; i < bin_size; i++) {
    fputc(bin_buf[i], fp);
  }
  for (; i & 0x3; i++) {
    fputc(0x00, fp);
  }
  for (int i = 0; i < 0x18; i++) {
    fputc(mach_o_footer[i], fp);
  }
}

uint8_t mach_o_header[0x130] = {
    0xcf,
    0xfa,
    0xed,
    0xfe,
    0x07,
    0x00,
    0x00,
    0x01,
    0x03,
    0x00,
    0x00,
    0x00,
    0x01,
    0x00,
    0x00,
    0x00,
    0x04,
    0x00,
    0x00,
    0x00,
    0x10,
    0x01,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x19,
    0x00,
    0x00,
    0x00,
    0x98,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x08,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x30,
    0x01,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x08,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x07,
    0x00,
    0x00,
    0x00,
    0x07,
    0x00,
    0x00,
    0x00,
    0x01,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,

    0x5f,
    0x5f,
    0x74,
    0x65,
    0x78,
    0x74,
    0x00,
    0x00, // "__text"
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x5f,
    0x5f,
    0x54,
    0x45,
    0x58,
    0x54,
    0x00,
    0x00, // "__TEXT"
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x08,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x30,
    0x01,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x04,
    0x00,
    0x80,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x24,
    0x00,
    0x00,
    0x00,
    0x10,
    0x00,
    0x00,
    0x00,
    0x00,
    0x0c,
    0x0a,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x02,
    0x00,
    0x00,
    0x00,
    0x18,
    0x00,
    0x00,
    0x00,
    // +0xd0
    0x38,
    0x01,
    0x00,
    0x00,
    0x01,
    0x00,
    0x00,
    0x00,
    0x48,
    0x01,
    0x00,
    0x00,
    0x08,
    0x00,
    0x00,
    0x00,
    0x0b,
    0x00,
    0x00,
    0x00,
    0x50,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x01,
    0x00,
    0x00,
    0x00,
    0x01,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
};

uint8_t mach_o_footer[0x18] = {
    // labe infos?
    // [uint32_t label_name_offset in label names]
    // [uint32_t label_type?]
    // [uint32_t offset_in_binary?]
    // [uint32_t ???(zero filled)]
    //
    // label_type:
    //    0e 01 00 00 : local label?
    //    0f 01 00 00 : global label?
    0x01, 0x00, 0x00, 0x00, 0x0f, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00,
    // label names. each label names should be null terminated.
    // 0x00, ["label name", ...] [padding to align 4-bytes]
    0x00, 0x5f, 0x6d, 0x61, 0x69, 0x6e, 0x00, 0x00, // "_main"
};
